<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能做题系统</title>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            neutral: '#64748b',
            light: '#f1f5f9',
            dark: '#1e293b'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .btn-hover {
        @apply transition-all duration-300 transform hover:scale-105 hover:shadow-lg;
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-light to-gray-200 min-h-screen font-sans text-dark">
  <div class="container max-w-2xl mx-auto px-4 py-8">
    <!-- 第一个界面：配置界面 -->
    <div id="config-page" class="bg-white rounded-xl p-6 card-shadow">
      <div class="text-center mb-6">
        <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">做题配置</h1>
        <p class="text-neutral">请选择科目和题目数量开始练习</p>
      </div>
      
      <div class="space-y-5">
        <div>
          <label for="subject" class="block text-sm font-medium text-gray-700 mb-1.5">
            <i class="fa fa-book mr-2 text-primary"></i>科目
          </label>
          <select id="subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
            <option value="语文">语文</option>
            <option value="数学">数学</option>
            <option value="英语">英语</option>
            <option value="物理">物理</option>
            <option value="化学">化学</option>
            <option value="历史">历史</option>
            <option value="道法">道法</option>
          </select>
        </div>
        
        <div>
          <label for="choice-count" class="block text-sm font-medium text-gray-700 mb-1.5">
            <i class="fa fa-list-ul mr-2 text-primary"></i>选择题数量
          </label>
          <input type="number" id="choice-count" min="0" value="0" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        
        <div>
          <label for="fill-count" class="block text-sm font-medium text-gray-700 mb-1.5">
            <i class="fa fa-pencil mr-2 text-primary"></i>填空题数量
          </label>
          <input type="number" id="fill-count" min="0" value="0" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        
        <div>
          <label for="material-count" class="block text-sm font-medium text-gray-700 mb-1.5">
            <i class="fa fa-file-text mr-2 text-primary"></i>材料题（解答题）数量
          </label>
          <input type="number" id="material-count" min="0" value="0" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        
        <div class="flex flex-wrap gap-3 mt-6">
          <button id="start-btn" class="flex-1 bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover">
            <i class="fa fa-play mr-2"></i>开始做题
          </button>
          <button id="history-btn" class="flex-1 bg-neutral text-white font-medium py-2.5 px-4 rounded-lg btn-hover">
            <i class="fa fa-history mr-2"></i>历史记录
          </button>
        </div>
      </div>
    </div>

    <!-- 第二个界面：做题界面 -->
    <div id="question-page" class="bg-white rounded-xl p-6 card-shadow" style="display: none;">
      <div id="header" class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
        <div class="flex items-center text-neutral">
          <i class="fa fa-clock-o mr-2"></i>
          <span id="timer" class="font-medium">00:00</span>
        </div>
        <div class="flex items-center text-neutral">
          <i class="fa fa-progress mr-2"></i>
          <span id="progress" class="font-medium">0/0</span>
        </div>
        <div class="flex items-center px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium">
          <i class="fa fa-bookmark-o mr-1"></i>
          <span id="current-subject"></span>
        </div>
      </div>
      
      <div id="question-container" class="min-h-[300px] mb-6"></div>
      
      <div class="flex justify-between">
        <button id="prev-btn" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover" style="display: none;">
          <i class="fa fa-arrow-left mr-1"></i>上一题
        </button>
        <button id="next-btn" class="bg-primary text-white font-medium py-2 px-4 rounded-lg btn-hover">
          下一题<i class="fa fa-arrow-right ml-1"></i>
        </button>
        <button id="submit-btn" class="bg-secondary text-white font-medium py-2 px-4 rounded-lg btn-hover" style="display: none;">
          <i class="fa fa-check mr-1"></i>提交答案
        </button>
      </div>
    </div>
  </div>

  <!-- 结果弹窗 -->
  <div id="result-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 card-shadow">
      <h2 class="text-xl font-bold text-center text-primary mb-4">做题结果</h2>
      <div id="result-content" class="max-h-[400px] overflow-y-auto mb-5 text-sm space-y-2"></div>
      <div class="flex gap-3">
        <button id="back-btn" class="flex-1 bg-neutral text-white font-medium py-2 rounded-lg btn-hover">
          <i class="fa fa-home mr-1"></i>返回首页
        </button>
        <button id="export-result-btn" class="flex-1 bg-primary text-white font-medium py-2 rounded-lg btn-hover">
          <i class="fa fa-download mr-1"></i>导出结果
        </button>
      </div>
    </div>
  </div>

  <script>
    // 存储题目数据的全局变量
    let questions = [];
    // 存储用户答案的数组
    let userAnswers = [];
    // 记录当前题目索引
    let currentQuestionIndex = 0;
    // 计时器相关变量
    let timerInterval;
    let secondsElapsed = 0;

    // 科目对应的题目文件和历史记录文件的映射
    const subjectFileMap = {
      语文: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/chinese/main/chinese_problem.csv', // 请填写语文题目的 CSV 文件 URL
        historyFile: 'chinese_history.csv'  // 统一为学科+_history.csv格式
      },
      数学: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/Math/main/math_problem.csv', // 请填写数学题目的 CSV 文件 URL
        historyFile:'math_history.csv'      // 统一为学科+_history.csv格式
      },
      英语: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/English/main/english_problem.csv', // 请填写英语题目的 CSV 文件 URL
        historyFile: 'english_history.csv'  // 统一为学科+_history.csv格式
      },
      物理: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/Physics/main/physics_problem.csv', // 请填写物理题目的 CSV 文件 URL
        historyFile: 'physics_history.csv'  // 统一为学科+_history.csv格式
      },
      化学: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/chemistry/main/chemistry_problem.csv', // 请填写化学题目的 CSV 文件 URL
        historyFile: 'chemistry_history.csv' // 统一为学科+_history.csv格式
      },
      历史: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/History/main/history_problem.csv', // 请填写历史题目的 CSV 文件 URL
        historyFile: 'history_history.csv'  // 统一为学科+_history.csv格式
      },
      道法: {
        questionFile: 'https://raw.githubusercontent.com/suitao-coder/Politics/main/politics_problem.csv', // 请填写道法题目的 CSV 文件 URL
        historyFile: 'politics_history.csv' // 统一为学科+_history.csv格式
      }
    };

    // 获取页面元素
    const configPage = document.getElementById('config-page');
    const questionPage = document.getElementById('question-page');
    const subjectSelect = document.getElementById('subject');
    const choiceCountInput = document.getElementById('choice-count');
    const fillCountInput = document.getElementById('fill-count');
    const materialCountInput = document.getElementById('material-count');
    const startBtn = document.getElementById('start-btn');
    const historyBtn = document.getElementById('history-btn');
    const timerSpan = document.getElementById('timer');
    const progressSpan = document.getElementById('progress');
    const currentSubjectSpan = document.getElementById('current-subject');
    const questionContainer = document.getElementById('question-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const resultModal = document.getElementById('result-modal');
    const resultContent = document.getElementById('result-content');
    const backBtn = document.getElementById('back-btn');
    const exportResultBtn = document.getElementById('export-result-btn');

    // 初始化事件监听
    function initEventListeners() {
      startBtn.addEventListener('click', startQuizSetup);
      historyBtn.addEventListener('click', exportHistory);
      prevBtn.addEventListener('click', goToPrevQuestion);
      nextBtn.addEventListener('click', goToNextQuestion);
      submitBtn.addEventListener('click', submitAnswers);
      backBtn.addEventListener('click', returnToConfig);
      exportResultBtn.addEventListener('click', exportCurrentResult);
    }

    // 开始做题设置
    async function startQuizSetup() {
      const subject = subjectSelect.value;
      const choiceCount = parseInt(choiceCountInput.value) || 0;
      const fillCount = parseInt(fillCountInput.value) || 0;
      const materialCount = parseInt(materialCountInput.value) || 0;

      // 验证输入
      if (choiceCount <= 0 && fillCount <= 0 && materialCount <= 0) {
        alert('请至少选择一种题型并设置数量');
        return;
      }

      const csvUrl = subjectFileMap[subject].questionFile;
      if (!csvUrl) {
        alert('请配置该科目的题目文件URL');
        return;
      }

      try {
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error('网络请求失败');
        
        const csvText = await response.text();
        const allQuestions = parseCSV(csvText);
        
        // 筛选出对应题型和数量的题目
        const filteredQuestions = filterQuestions(allQuestions, choiceCount, fillCount, materialCount);
        if (filteredQuestions.length === 0) {
          alert('没有符合条件的题目，请调整题目数量。');
          return;
        }
        
        questions = filteredQuestions;
        userAnswers = new Array(questions.length).fill('');
        currentQuestionIndex = 0;
        secondsElapsed = 0;
        
        startQuiz();
      } catch (error) {
        console.error('加载题目数据出错:', error);
        alert('加载题目数据出错，请检查网络或配置。');
      }
    }

    // 开始做题
    function startQuiz() {
      configPage.style.display = 'none';
      questionPage.style.display = 'block';
      currentSubjectSpan.textContent = subjectSelect.value;
      
      // 重置计时器
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      
      showQuestion();
      updateNavigationButtons();
    }

    // 显示当前题目
    function showQuestion() {
      if (currentQuestionIndex >= questions.length) return;
      
      const question = questions[currentQuestionIndex];
      progressSpan.textContent = `${currentQuestionIndex + 1}/${questions.length}`;
      questionContainer.innerHTML = '';
      
      // 题目类型标签
      const typeBadge = document.createElement('span');
      typeBadge.className = 'inline-block px-2 py-0.5 bg-gray-100 text-gray-800 text-xs font-medium rounded mb-3';
      typeBadge.textContent = question['题型'];
      questionContainer.appendChild(typeBadge);
      
      // 题目内容
      const questionText = document.createElement('h3');
      questionText.className = 'text-lg font-medium mb-4 text-gray-800';
      questionText.textContent = `题目 ${currentQuestionIndex + 1}: ${question['题目']}`;
      questionContainer.appendChild(questionText);
      
      // 根据题型显示不同的答题区域
      if (question['题型'] === '选择题') {
        const choices = ['A', 'B', 'C', 'D'];
        const choicesContainer = document.createElement('div');
        choicesContainer.className = 'space-y-3';
        
        choices.forEach(choice => {
          if (question[choice]) {
            const div = document.createElement('div');
            div.className = 'flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `question-${currentQuestionIndex}`;
            radio.value = choice;
            radio.id = `q${currentQuestionIndex}-${choice}`;
            radio.className = 'w-4 h-4 text-primary focus:ring-primary';
            if (userAnswers[currentQuestionIndex] === choice) {
              radio.checked = true;
            }
            
            const label = document.createElement('label');
            label.htmlFor = `q${currentQuestionIndex}-${choice}`;
            label.className = 'ml-3 text-gray-700';
            label.textContent = `${choice}: ${question[choice]}`;
            
            radio.addEventListener('change', (e) => {
              userAnswers[currentQuestionIndex] = e.target.value;
            });
            
            div.appendChild(radio);
            div.appendChild(label);
            choicesContainer.appendChild(div);
          }
        });
        
        questionContainer.appendChild(choicesContainer);
      } else {
        // 填空题或材料题
        const input = document.createElement('textarea');
        input.className = 'w-full p-3 border border-gray-300 rounded-lg input-focus min-h-[100px] resize-y';
        input.placeholder = `请输入${question['题型']}答案`;
        input.value = userAnswers[currentQuestionIndex] || '';
        input.addEventListener('input', (e) => {
          userAnswers[currentQuestionIndex] = e.target.value;
        });
        
        questionContainer.appendChild(input);
      }
    }

    // 更新计时器
    function updateTimer() {
      secondsElapsed++;
      const minutes = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
      const seconds = (secondsElapsed % 60).toString().padStart(2, '0');
      timerSpan.textContent = `${minutes}:${seconds}`;
      
      // 超过10分钟添加警告样式
      if (secondsElapsed > 600) {
        timerSpan.classList.add('text-warning', 'font-bold');
      } else {
        timerSpan.classList.remove('text-warning', 'font-bold');
      }
    }

    // 上一题
    function goToPrevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion();
        updateNavigationButtons();
      }
    }

    // 下一题
    function goToNextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        showQuestion();
        updateNavigationButtons();
      }
    }

    // 更新导航按钮状态
    function updateNavigationButtons() {
      // 第一题隐藏上一题按钮
      prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
      
      // 最后一题显示提交按钮，隐藏下一题按钮
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      }
    }

    // 提交答案
    function submitAnswers() {
      clearInterval(timerInterval);
      showResults();
    }

    // 显示结果
    function showResults() {
      resultContent.innerHTML = '';
      let correctCount = 0;
      
      questions.forEach((question, index) => {
        const userAnswer = userAnswers[index] || '';
        const isCorrect = question['题型'] === '选择题' 
          ? userAnswer === question['答案'] 
          : userAnswer.trim() === question['答案'].trim();
        
        if (isCorrect) correctCount++;
        
        const resultItem = document.createElement('div');
        resultItem.className = `p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-100' : 'bg-red-50 border border-red-100'}`;
        
        resultItem.innerHTML = `
          <div class="font-medium mb-1">题目 ${index + 1} (${question['题型']})</div>
          <div class="text-sm text-gray-600 mb-1">${question['题目']}</div>
          <div class="text-sm"><span class="text-gray-600">你的答案：</span>${userAnswer || '未作答'}</div>
          <div class="text-sm"><span class="text-gray-600">正确答案：</span>${question['答案']}</div>
          <div class="text-sm font-medium mt-1 ${isCorrect ? 'text-green-600' : 'text-red-600'}">
            ${isCorrect ? '正确' : '错误'}
          </div>
        `;
        
        resultContent.appendChild(resultItem);
      });
      
      // 添加总分
      const scoreItem = document.createElement('div');
      scoreItem.className = 'p-3 bg-primary/5 rounded-lg text-center mt-4';
      scoreItem.innerHTML = `
        <div class="text-lg font-bold text-primary">
          总得分：${correctCount}/${questions.length}
        </div>
        <div class="text-sm text-gray-600">正确率：${((correctCount/questions.length)*100).toFixed(1)}%</div>
        <div class="text-sm text-gray-600">用时：${timerSpan.textContent}</div>
      `;
      resultContent.prepend(scoreItem);
      
      // 保存到历史记录
      saveHistory();
      
      // 显示结果弹窗
      resultModal.style.display = 'flex';
    }

    // 保存历史记录
    function saveHistory() {
      const subject = subjectSelect.value;
      const results = questions.map((question, index) => {
        const userAnswer = userAnswers[index] || '';
        return {
          科目: subject,
          题目: question['题目'],
          题型: question['题型'],
          用户答案: userAnswer,
          正确答案: question['答案'],
          是否正确: question['题型'] === '选择题' 
            ? userAnswer === question['答案'] 
            : userAnswer.trim() === question['答案'].trim(),
          用时: timerSpan.textContent,
          日期: new Date().toLocaleString()
        };
      });
      
      const csvHeaders = ['科目', '题目', '题型', '用户答案', '正确答案', '是否正确', '用时', '日期'];
      let csvContent = csvHeaders.join(',') + '\n';
      
      results.forEach(result => {
        const row = csvHeaders.map(header => {
          // 处理包含逗号的内容
          const value = result[header].toString();
          return value.includes(',') ? `"${value}"` : value;
        }).join(',');
        csvContent += row + '\n';
      });
      
      const historyKey = `${subject}_historyRecords`;
      const existingHistory = localStorage.getItem(historyKey);
      if (existingHistory) {
        csvContent = existingHistory + csvContent;
      }
      
      localStorage.setItem(historyKey, csvContent);
    }

    // 导出历史记录
    function exportHistory() {
      const subject = subjectSelect.value;
      const historyKey = `${subject}_historyRecords`;
      const historyRecords = localStorage.getItem(historyKey);
      
      if (historyRecords) {
        downloadCSV(historyRecords, subjectFileMap[subject].historyFile);
      } else {
        alert('该科目暂无历史记录。');
      }
    }

    // 导出当前结果
    function exportCurrentResult() {
      const subject = subjectSelect.value;
      const results = questions.map((question, index) => {
        const userAnswer = userAnswers[index] || '';
        return {
          科目: subject,
          题目: question['题目'],
          题型: question['题型'],
          用户答案: userAnswer,
          正确答案: question['答案'],
          是否正确: question['题型'] === '选择题' 
            ? userAnswer === question['答案'] 
            : userAnswer.trim() === question['答案'].trim(),
          用时: timerSpan.textContent,
          日期: new Date().toLocaleString()
        };
      });
      
      const csvHeaders = ['科目', '题目', '题型', '用户答案', '正确答案', '是否正确', '用时', '日期'];
      let csvContent = csvHeaders.join(',') + '\n';
      
      results.forEach(result => {
        const row = csvHeaders.map(header => {
          const value = result[header].toString();
          return value.includes(',') ? `"${value}"` : value;
        }).join(',');
        csvContent += row + '\n';
      });
      
      const fileName = `${subject}_result_${new Date().getTime()}.csv`;
      downloadCSV(csvContent, fileName);
    }

    // 下载CSV文件
    function downloadCSV(content, fileName) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 返回配置页面
    function returnToConfig() {
      resultModal.style.display = 'none';
      questionPage.style.display = 'none';
      configPage.style.display = 'block';
      clearInterval(timerInterval);
    }

    // 解析CSV文件为题目数组
    function parseCSV(csvText) {
      // 处理可能的BOM头
      if (csvText.charCodeAt(0) === 0xFEFF) {
        csvText = csvText.substring(1);
      }
      
      const lines = csvText.split('\n')
        .map(line => line.trim())
        .filter(line => line);
      
      if (lines.length === 0) return [];
      
      const headers = lines[0].split(',').map(header => header.trim());
      const result = [];
      
      for (let i = 1; i < lines.length; i++) {
        const currentLine = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
          .map(field => {
            // 移除可能的引号
            if (field.startsWith('"') && field.endsWith('"')) {
              return field.substring(1, field.length - 1);
            }
            return field.trim();
          });
        
        const obj = {};
        for (let j = 0; j < headers.length; j++) {
          obj[headers[j]] = currentLine[j] || '';
        }
        result.push(obj);
      }
      
      return result;
    }

    // 筛选题目
    function filterQuestions(allQuestions, choiceCount, fillCount, materialCount) {
      const choiceQuestions = allQuestions
        .filter(q => q['题型'] === '选择题')
        .sort(() => 0.5 - Math.random()) // 随机排序
        .slice(0, choiceCount);
      
      const fillQuestions = allQuestions
        .filter(q => q['题型'] === '填空题')
        .sort(() => 0.5 - Math.random())
        .slice(0, fillCount);
      
      const materialQuestions = allQuestions
        .filter(q => q['题型'] === '材料题（解答题）')
        .sort(() => 0.5 - Math.random())
        .slice(0, materialCount);
      
      return [...choiceQuestions, ...fillQuestions, ...materialQuestions];
    }

    // 初始化应用
    function initApp() {
      initEventListeners();
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>

</html>
